# ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ‘Ğ¸Ñ‚Ğ¾Ğ²Ñ‹Ñ… ĞœĞ°ÑĞ¾Ğº

## ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°

ĞŸÑ€Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğµ permissions Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ğ°Ñ Ğ¼Ğ°ÑĞºĞ° ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ğ¾Ğ³Ñ€Ğ¾Ğ¼Ğ½Ğ¾Ğ¹:

```php
// 10,000 Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… permissions Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ
// ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¸Ğ¼ĞµĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 5 Ğ¸Ğ· Ğ½Ğ¸Ñ…: [0, 100, 1000, 5000, 9999]

// Ğ¢Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ°Ñ Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ğ°Ñ Ğ¼Ğ°ÑĞºĞ°:
$bitmask = "Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ñ 3000+ Ñ†Ğ¸Ñ„Ñ€Ğ°Ğ¼Ğ¸";
// Ğ Ğ°Ğ·Ğ¼ĞµÑ€: 3015 Ğ±Ğ°Ğ¹Ñ‚
```

## Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: BitmaskOptimizer

Ğ’Ğ¼ĞµÑÑ‚Ğ¾ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ²ÑĞµĞ¹ Ğ¼Ğ°ÑĞºĞ¸ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ **Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ±Ğ¸Ñ‚Ğ¾Ğ²**:

```php
use DFiks\UnPerm\Support\BitmaskOptimizer;

// Ğ‘Ñ‹Ğ»Ğ¾: 3015 Ğ±Ğ°Ğ¹Ñ‚
$bitmask = BitmaskOptimizer::fromIndices([0, 100, 1000, 5000, 9999]);

// Ğ¡Ñ‚Ğ°Ğ»Ğ¾: ~35 Ğ±Ğ°Ğ¹Ñ‚ (JSON Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¸Ğ½Ğ´ĞµĞºÑĞ¾Ğ²)
$optimized = BitmaskOptimizer::compress($bitmask);
// "[0,100,1000,5000,9999]"

// Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ: 98.8% !
```

## ĞšĞ¾Ğ³Ğ´Ğ° ÑÑ‚Ğ¾ Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾?

### âœ… Ğ’Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ (Ñ€Ğ°Ğ·Ñ€ĞµĞ¶ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)

```php
// Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: 10,000 permissions, Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¸Ğ¼ĞµĞµÑ‚ 10
$indices = [5, 42, 100, 256, 789, 1024, 2000, 3500, 4500, 9999];
$bitmask = BitmaskOptimizer::fromIndices($indices);

$stats = BitmaskOptimizer::getStats($bitmask);
// bits_set: 10
// total_size: 3015 Ğ±Ğ°Ğ¹Ñ‚
// compressed_size: 45 Ğ±Ğ°Ğ¹Ñ‚
// compression_ratio: 98.5% ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ ğŸ’š
```

### âŒ ĞĞµ Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ (Ğ¿Ğ»Ğ¾Ñ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)

```php
// Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: 200 permissions, Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¸Ğ¼ĞµĞµÑ‚ 150
$indices = range(0, 149); // 150 permissions
$bitmask = BitmaskOptimizer::fromIndices($indices);

$stats = BitmaskOptimizer::getStats($bitmask);
// bits_set: 150
// total_size: 62 Ğ±Ğ°Ğ¹Ñ‚Ğ°
// compressed_size: 600+ Ğ±Ğ°Ğ¹Ñ‚ (Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¹ JSON Ğ¼Ğ°ÑÑĞ¸Ğ²)
// compression_ratio: -870% (ÑÑ‚Ğ°Ğ»Ğ¾ Ğ¥Ğ£Ğ–Ğ•!) âŒ
```

## ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°

```php
use DFiks\UnPerm\Support\BitmaskOptimizer;

// ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
$optimized = BitmaskOptimizer::optimize($bitmask);

if ($optimized['type'] === 'indices') {
    echo "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¶Ğ°Ñ‚Ğ¸Ğµ (ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ Ğ¼ĞµÑÑ‚Ğ°)";
    // data: "[5,42,100,...]"
} else {
    echo "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ±Ğ¸Ñ‚Ğ¾Ğ²ÑƒÑ Ğ¼Ğ°ÑĞºÑƒ (Ğ±Ğ¾Ğ»ĞµĞµ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾)";
    // data: "1234567890..."
}

// Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ
$original = BitmaskOptimizer::restore($optimized);
```

## Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

```php
use DFiks\UnPerm\Support\BitmaskOptimizer;
use DFiks\UnPerm\Traits\HasPermissions;

class User extends Model
{
    use HasPermissions;
    
    // ĞŸĞ¾Ğ»Ğµ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°
    protected $casts = [
        'permissions_meta' => 'array',
    ];
    
    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ±Ğ¸Ñ‚Ğ¾Ğ²ÑƒÑ Ğ¼Ğ°ÑĞºÑƒ Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹
     */
    public function getOptimizedPermissionBitmask(): string
    {
        $bitmask = $this->getPermissionBitmask();
        
        // ĞšĞµÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
        if (!$this->permissions_meta) {
            $this->permissions_meta = BitmaskOptimizer::optimize($bitmask);
            $this->save();
        }
        
        return BitmaskOptimizer::restore($this->permissions_meta);
    }
    
    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹
     */
    public function hasOptimizedAction(string $action): bool
    {
        $bitmask = $this->getOptimizedPermissionBitmask();
        return \DFiks\UnPerm\Support\PermBit::hasAction($bitmask, $action);
    }
}
```

## ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```bash
php artisan unperm:analyze-bitmask
```

Ğ’Ñ‹Ğ²Ğ¾Ğ´:
```
Analyzing bitmask storage efficiency...

â•â•â• Actions â•â•â•
+----------------+------------------+-------------+----------+------------+-----------+
| Name           | Slug             | Permissions | Original | Compressed | Savings % |
+----------------+------------------+-------------+----------+------------+-----------+
| Large Action   | large.permission | 1           | 3.2 KB   | 15 B       | 99.5%     |
| Medium Action  | med.permission   | 5           | 1.5 KB   | 35 B       | 97.7%     |
+----------------+------------------+-------------+----------+------------+-----------+

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

+--------+-------+---------------+-----------------+-----------+
| Type   | Count | Original Size | Compressed Size | Savings % |
+--------+-------+---------------+-----------------+-----------+
| Actions| 25    | 15.2 KB       | 850 B           | 94.4%     |
| Roles  | 10    | 8.5 KB        | 450 B           | 94.7%     |
| Groups | 5     | 4.1 KB        | 200 B           | 95.1%     |
| TOTAL  | 40    | 27.8 KB       | 1.5 KB          | 94.6%     |
+--------+-------+---------------+-----------------+-----------+

ğŸ’¡ Significant savings possible! Consider implementing BitmaskOptimizer.
   For sparse permissions (few assigned), compression can save 95% of storage.
```

## Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¾Ğ²

| ĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´ | Ğ Ğ°Ğ·Ğ¼ĞµÑ€ (10 Ğ¸Ğ· 10k) | Ğ Ğ°Ğ·Ğ¼ĞµÑ€ (5000 Ğ¸Ğ· 10k) | ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° |
|--------|-------------------|---------------------|----------|
| **ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¼Ğ°ÑĞºĞ°** | 3015 Ğ±Ğ°Ğ¹Ñ‚ | 3015 Ğ±Ğ°Ğ¹Ñ‚ | O(1) Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ğ°Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ |
| **Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹ (Optimizer)** | 45 Ğ±Ğ°Ğ¹Ñ‚ | 30 KB | O(1) Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ |
| **Ğ“Ğ¸Ğ±Ñ€Ğ¸Ğ´Ğ½Ñ‹Ğ¹ (auto)** | 45 Ğ±Ğ°Ğ¹Ñ‚ | 3015 Ğ±Ğ°Ğ¹Ñ‚ | O(1) Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ğ°Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ |

## Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸

### ĞœĞ°Ğ»Ñ‹Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ (< 1000 permissions)
- âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¼Ğ°ÑĞºĞ¸
- Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼Ñ‹Ğ¹ (~300 Ğ±Ğ°Ğ¹Ñ‚ max)
- ĞĞµÑ‚ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ² Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ (1000-5000 permissions)
- âœ… ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ `unperm:analyze-bitmask`
- ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞ¹Ñ‚Ğµ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€ĞµĞ¶ĞµĞ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ (> 5000 permissions)
- âœ… ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ BitmaskOptimizer
- Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ 90-99%
- ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚Ğ¸

## ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ

```php
// Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ² Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ
Schema::table('users', function (Blueprint $table) {
    $table->json('permissions_optimized')->nullable();
});

// ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
foreach (User::all() as $user) {
    $bitmask = $user->getPermissionBitmask();
    $user->permissions_optimized = BitmaskOptimizer::optimize($bitmask);
    $user->save();
}
```

## Ğ—Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ

**BitmaskOptimizer** Ñ€ĞµÑˆĞ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ñ‹Ñ… Ğ¼Ğ°ÑĞ¾Ğº Ğ´Ğ»Ñ ÑĞ¸ÑÑ‚ĞµĞ¼ Ñ:
- Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾Ğ¼ permissions (1000+)
- Ğ Ğ°Ğ·Ñ€ĞµĞ¶ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ĞµĞ¼ (Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¸Ğ¼ĞµÑÑ‚ < 10% Ğ¾Ñ‚ Ğ²ÑĞµÑ…)
- Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸ Ğº Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚Ğ¸

**Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ: Ğ´Ğ¾ 99% Ğ¼ĞµÑÑ‚Ğ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ O(1) Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸!**

